<?php
header("Content-Type: application/json");
error_reporting(0);  // 🎯 PHP の警告を抑制
ini_set('display_errors', 0);  // 🎯 画面上にエラーを表示しない
include('db.php');

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    try {
        // 🎯 ランダムなルームIDを生成
        $roomID = "room_" . bin2hex(random_bytes(4));

        // 🎯 ルーム専用のテーブルを作成（プレイヤーデータを保存）
        $sql = "CREATE TABLE `$roomID` (
            id INT AUTO_INCREMENT PRIMARY KEY,
            username VARCHAR(50) NOT NULL,
            x INT DEFAULT 0,
            y INT DEFAULT 0,
            mapID VARCHAR(20) NOT NULL DEFAULT 'map-01', -- ✅ 追加: プレイヤーのいるマップを記録
            hp INT DEFAULT 10 CHECK (hp BETWEEN 0 AND 10),
            token VARCHAR(32) UNIQUE NOT NULL,
            playersize ENUM('small', 'normal', 'big') DEFAULT 'normal',
            Card_ID_001 BOOLEAN DEFAULT FALSE,
            Card_ID_002 BOOLEAN DEFAULT FALSE,
            Card_ID_003 BOOLEAN DEFAULT FALSE,
            Card_ID_004 BOOLEAN DEFAULT FALSE,
            Card_ID_005 BOOLEAN DEFAULT FALSE,
            Card_ID_006 BOOLEAN DEFAULT FALSE,
            Card_ID_007 BOOLEAN DEFAULT FALSE,
            Card_ID_008 BOOLEAN DEFAULT FALSE,
            Card_ID_009 INT DEFAULT 0 CHECK (Card_ID_009 >= 0),
            Card_ID_010 INT DEFAULT 0 CHECK (Card_ID_010 >= 0),
            Card_ID_011 INT DEFAULT 0 CHECK (Card_ID_011 >= 0),
            Card_ID_012 INT DEFAULT 0 CHECK (Card_ID_012 >= 0),
            Card_ID_013 INT DEFAULT 0 CHECK (Card_ID_013 >= 0),
            Card_ID_014 INT DEFAULT 0 CHECK (Card_ID_014 >= 0),
            Card_ID_015 INT DEFAULT 0 CHECK (Card_ID_015 >= 0),
            Card_ID_016 INT DEFAULT 0 CHECK (Card_ID_016 >= 0),
            Card_ID_017 INT DEFAULT 0 CHECK (Card_ID_017 >= 0),
            Card_ID_018 INT DEFAULT 0 CHECK (Card_ID_018 >= 0),
            Card_ID_019 INT DEFAULT 0 CHECK (Card_ID_019 >= 0),
            Card_ID_020 INT DEFAULT 0 CHECK (Card_ID_020 >= 0),
            Card_ID_021 INT DEFAULT 0 CHECK (Card_ID_021 >= 0),
            Card_ID_022 INT DEFAULT 0 CHECK (Card_ID_022 >= 0),
            Card_ID_023 INT DEFAULT 0 CHECK (Card_ID_023 >= 0),
            Card_ID_024 INT DEFAULT 0 CHECK (Card_ID_024 >= 0),
            Card_ID_025 INT DEFAULT 0 CHECK (Card_ID_025 >= 0),
            Card_ID_026 INT DEFAULT 0 CHECK (Card_ID_026 >= 0),
            Card_ID_027 INT DEFAULT 0 CHECK (Card_ID_027 >= 0),
            Card_ID_028 INT DEFAULT 0 CHECK (Card_ID_028 >= 0),
            Card_ID_029 INT DEFAULT 0 CHECK (Card_ID_029 >= 0),
            Card_ID_030 INT DEFAULT 0 CHECK (Card_ID_030 >= 0),
            Card_ID_031 INT DEFAULT 0 CHECK (Card_ID_031 >= 0),
            Card_ID_032 INT DEFAULT 0 CHECK (Card_ID_032 >= 0),
            Card_ID_033 INT DEFAULT 0 CHECK (Card_ID_033 >= 0),
            Card_ID_034 INT DEFAULT 0 CHECK (Card_ID_034 >= 0),
            Card_ID_035 INT DEFAULT 0 CHECK (Card_ID_035 >= 0),
            Card_ID_036 INT DEFAULT 0 CHECK (Card_ID_036 >= 0),
            Card_ID_037 INT DEFAULT 0 CHECK (Card_ID_037 >= 0),
            Card_ID_038 INT DEFAULT 0 CHECK (Card_ID_038 >= 0),
            Card_ID_039 INT DEFAULT 0 CHECK (Card_ID_039 >= 0),
            Card_ID_040 INT DEFAULT 0 CHECK (Card_ID_040 >= 0),
            Card_ID_041 INT DEFAULT 0 CHECK (Card_ID_041 >= 0),
            Card_ID_042 INT DEFAULT 0 CHECK (Card_ID_042 >= 0),
            Card_ID_043 INT DEFAULT 0 CHECK (Card_ID_043 >= 0),
            Card_ID_044 INT DEFAULT 0 CHECK (Card_ID_044 >= 0),
            Card_ID_045 INT DEFAULT 0 CHECK (Card_ID_045 >= 0),
            Card_ID_046 INT DEFAULT 0 CHECK (Card_ID_046 >= 0),
            Card_ID_047 INT DEFAULT 0 CHECK (Card_ID_047 >= 0),
            Card_ID_048 INT DEFAULT 0 CHECK (Card_ID_048 >= 0),
            Card_ID_049 INT DEFAULT 0 CHECK (Card_ID_049 >= 0),
            Card_ID_050 INT DEFAULT 0 CHECK (Card_ID_050 >= 0),
            Card_ID_051 INT DEFAULT 0 CHECK (Card_ID_051 >= 0),
            Card_ID_052 INT DEFAULT 0 CHECK (Card_ID_052 >= 0),
            Card_ID_053 INT DEFAULT 0 CHECK (Card_ID_053 >= 0),
            Card_ID_054 INT DEFAULT 0 CHECK (Card_ID_054 >= 0),
            Card_ID_055 INT DEFAULT 0 CHECK (Card_ID_055 >= 0),
            Card_ID_056 INT DEFAULT 0 CHECK (Card_ID_056 >= 0),
            Card_ID_057 INT DEFAULT 0 CHECK (Card_ID_057 >= 0),
            Card_ID_058 INT DEFAULT 0 CHECK (Card_ID_058 >= 0),
            Card_ID_059 INT DEFAULT 0 CHECK (Card_ID_059 >= 0),
            Card_ID_060 INT DEFAULT 0 CHECK (Card_ID_060 >= 0),
            Card_ID_061 INT DEFAULT 0 CHECK (Card_ID_061 >= 0),
            Card_ID_062 INT DEFAULT 0 CHECK (Card_ID_062 >= 0),
            Card_ID_063 INT DEFAULT 0 CHECK (Card_ID_063 >= 0),
            Card_ID_064 INT DEFAULT 0 CHECK (Card_ID_064 >= 0),
            Card_ID_065 INT DEFAULT 0 CHECK (Card_ID_065 >= 0),
            Card_ID_066 INT DEFAULT 0 CHECK (Card_ID_066 >= 0),
            Card_ID_067 INT DEFAULT 0 CHECK (Card_ID_067 >= 0),
            Card_ID_068 INT DEFAULT 0 CHECK (Card_ID_068 >= 0),
            Card_ID_069 INT DEFAULT 0 CHECK (Card_ID_069 >= 0),
            Card_ID_070 INT DEFAULT 0 CHECK (Card_ID_070 >= 0),
            Card_ID_071 INT DEFAULT 0 CHECK (Card_ID_071 >= 0),
            Card_ID_072 INT DEFAULT 0 CHECK (Card_ID_072 >= 0),
            Card_ID_073 INT DEFAULT 0 CHECK (Card_ID_073 >= 0),
            Card_ID_074 INT DEFAULT 0 CHECK (Card_ID_074 >= 0),
            Card_ID_075 INT DEFAULT 0 CHECK (Card_ID_075 >= 0),
            Card_ID_076 INT DEFAULT 0 CHECK (Card_ID_076 >= 0),
            Card_ID_077 INT DEFAULT 0 CHECK (Card_ID_077 >= 0),
            Card_ID_078 INT DEFAULT 0 CHECK (Card_ID_078 >= 0),
            Card_ID_079 INT DEFAULT 0 CHECK (Card_ID_079 >= 0),
            Card_ID_080 INT DEFAULT 0 CHECK (Card_ID_080 >= 0),
            Card_ID_081 INT DEFAULT 0 CHECK (Card_ID_081 >= 0),
            Card_ID_082 INT DEFAULT 0 CHECK (Card_ID_082 >= 0),
            Card_ID_083 INT DEFAULT 0 CHECK (Card_ID_083 >= 0),
            Card_ID_084 INT DEFAULT 0 CHECK (Card_ID_084 >= 0),
            Card_ID_085 INT DEFAULT 0 CHECK (Card_ID_085 >= 0),
            Card_ID_086 INT DEFAULT 0 CHECK (Card_ID_086 >= 0),
            Card_ID_087 INT DEFAULT 0 CHECK (Card_ID_087 >= 0),
            Card_ID_088 INT DEFAULT 0 CHECK (Card_ID_088 >= 0),
            Card_ID_089 INT DEFAULT 0 CHECK (Card_ID_089 >= 0),
            Card_ID_090 INT DEFAULT 0 CHECK (Card_ID_090 >= 0),
            Card_ID_091 INT DEFAULT 0 CHECK (Card_ID_091 >= 0),
            Card_ID_092 INT DEFAULT 0 CHECK (Card_ID_092 >= 0),
            Card_ID_093 INT DEFAULT 0 CHECK (Card_ID_093 >= 0),
            Card_ID_094 INT DEFAULT 0 CHECK (Card_ID_094 >= 0),
            Card_ID_095 INT DEFAULT 0 CHECK (Card_ID_095 >= 0),
            Card_ID_096 INT DEFAULT 0 CHECK (Card_ID_096 >= 0),
            Card_ID_097 INT DEFAULT 0 CHECK (Card_ID_097 >= 0),
            Card_ID_098 INT DEFAULT 0 CHECK (Card_ID_098 >= 0),
            Card_ID_099 INT DEFAULT 0 CHECK (Card_ID_099 >= 0),
            Card_ID_100 INT DEFAULT 0 CHECK (Card_ID_100 >= 0),
            Card_ID_101 INT DEFAULT 0 CHECK (Card_ID_101 >= 0),
            Card_ID_102 INT DEFAULT 0 CHECK (Card_ID_102 >= 0),
            Card_ID_103 INT DEFAULT 0 CHECK (Card_ID_103 >= 0),
            Card_ID_104 INT DEFAULT 0 CHECK (Card_ID_104 >= 0),
            Card_ID_105 INT DEFAULT 0 CHECK (Card_ID_105 >= 0),
            Card_ID_106 INT DEFAULT 0 CHECK (Card_ID_106 >= 0),
            Card_ID_107 INT DEFAULT 0 CHECK (Card_ID_107 >= 0),
            Card_ID_108 INT DEFAULT 0 CHECK (Card_ID_108 >= 0),
            Card_ID_109 INT DEFAULT 0 CHECK (Card_ID_109 >= 0),
            Card_ID_110 INT DEFAULT 0 CHECK (Card_ID_110 >= 0),
            Card_ID_111 INT DEFAULT 0 CHECK (Card_ID_111 >= 0),
            Card_ID_112 INT DEFAULT 0 CHECK (Card_ID_112 >= 0),
            Card_ID_113 INT DEFAULT 0 CHECK (Card_ID_113 >= 0),
            Card_ID_114 INT DEFAULT 0 CHECK (Card_ID_114 >= 0),
            Card_ID_115 INT DEFAULT 0 CHECK (Card_ID_115 >= 0),
            Card_ID_116 INT DEFAULT 0 CHECK (Card_ID_116 >= 0),
            Card_ID_117 INT DEFAULT 0 CHECK (Card_ID_117 >= 0),
            Card_ID_118 INT DEFAULT 0 CHECK (Card_ID_118 >= 0),
            Card_ID_119 INT DEFAULT 0 CHECK (Card_ID_119 >= 0),
            Card_ID_120 INT DEFAULT 0 CHECK (Card_ID_120 >= 0),
            Card_ID_121 INT DEFAULT 0 CHECK (Card_ID_121 >= 0),
            Card_ID_122 INT DEFAULT 0 CHECK (Card_ID_122 >= 0),
            Card_ID_123 INT DEFAULT 0 CHECK (Card_ID_123 >= 0),
            Card_ID_124 INT DEFAULT 0 CHECK (Card_ID_124 >= 0),
            Card_ID_125 INT DEFAULT 0 CHECK (Card_ID_125 >= 0),
            Card_ID_126 INT DEFAULT 0 CHECK (Card_ID_126 >= 0),
            Card_ID_127 INT DEFAULT 0 CHECK (Card_ID_127 >= 0),
            Card_ID_128 INT DEFAULT 0 CHECK (Card_ID_128 >= 0),
            Card_ID_129 INT DEFAULT 0 CHECK (Card_ID_129 >= 0),
            Card_ID_130 INT DEFAULT 0 CHECK (Card_ID_130 >= 0),
            Card_ID_131 INT DEFAULT 0 CHECK (Card_ID_131 >= 0),
            Card_ID_132 INT DEFAULT 0 CHECK (Card_ID_132 >= 0),
            Card_ID_133 INT DEFAULT 0 CHECK (Card_ID_133 >= 0),
            Card_ID_134 INT DEFAULT 0 CHECK (Card_ID_134 >= 0),
            Card_ID_135 INT DEFAULT 0 CHECK (Card_ID_135 >= 0),
            Card_ID_136 INT DEFAULT 0 CHECK (Card_ID_136 >= 0),
            Card_ID_137 INT DEFAULT 0 CHECK (Card_ID_137 >= 0),
            Card_ID_138 INT DEFAULT 0 CHECK (Card_ID_138 >= 0),
            Card_ID_139 INT DEFAULT 0 CHECK (Card_ID_139 >= 0),
            Card_ID_140 INT DEFAULT 0 CHECK (Card_ID_140 >= 0),
            Card_ID_141 INT DEFAULT 0 CHECK (Card_ID_141 >= 0),
            Card_ID_142 INT DEFAULT 0 CHECK (Card_ID_142 >= 0),
            Card_ID_143 INT DEFAULT 0 CHECK (Card_ID_143 >= 0),
            Card_ID_144 INT DEFAULT 0 CHECK (Card_ID_144 >= 0),
            Card_ID_145 INT DEFAULT 0 CHECK (Card_ID_145 >= 0),
            Card_ID_146 INT DEFAULT 0 CHECK (Card_ID_146 >= 0),
            Card_ID_147 INT DEFAULT 0 CHECK (Card_ID_147 >= 0),
            Card_ID_148 INT DEFAULT 0 CHECK (Card_ID_148 >= 0),
            Card_ID_149 INT DEFAULT 0 CHECK (Card_ID_149 >= 0),
            Card_ID_150 INT DEFAULT 0 CHECK (Card_ID_150 >= 0)
            Card_ID_0000 INT DEFAULT 0 CHECK (Card_ID_150 >= 0)

        )";        
        $pdo->exec($sql);

        echo json_encode(["success" => true, "roomID" => $roomID]);
    } catch (PDOException $e) {
        echo json_encode(["success" => false, "error" => "データベースエラー"]);
    }
}
?>
